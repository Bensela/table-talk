name: table-talk
region: nyc

# Feature flags
features:
  - buildpack-stack=ubuntu-22

# Deployment alerts
alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED
  - rule: DEPLOYMENT_LIVE

# Ingress routing rules
ingress:
  rules:
    # Route /api/* to backend service
    - component:
        name: backend
      match:
        path:
          prefix: /api
    
    # Route everything else to frontend
    - component:
        name: frontend
      match:
        path:
          prefix: /

# Backend service (Node.js/Express with Socket.io)
services:
  - name: backend
    
    # Source configuration
    github:
      repo: Bensela/table-talk  # UPDATE THIS to your fork
      branch: main
      deploy_on_push: true
    
    source_dir: backend
    
    # Build and run configuration
    build_command: npm ci
    run_command: npm start
    
    # HTTP configuration
    http_port: 8080
    
    # Resource allocation
    instance_size_slug: apps-s-1vcpu-1gb  # Basic: ~$12/month
    instance_count: 1  # Increase to 2-3 for production load balancing
    
    # Environment variables
    envs:
      - key: NODE_ENV
        value: production
        scope: RUN_TIME
      
      - key: PORT
        value: "8080"
        scope: RUN_TIME
      
      - key: LOG_LEVEL
        value: info
        scope: RUN_TIME
      
      # Frontend URL for CORS (magic variable)
      - key: FRONTEND_URL
        value: ${APP_URL}
        scope: RUN_TIME
      
      # Database connection (references attached database component)
      - key: DATABASE_URL
        value: ${db.DATABASE_URL}
        scope: RUN_TIME
        type: SECRET  # Encrypts the value
    
    # Health check configuration
    health_check:
      http_path: /api/health
      initial_delay_seconds: 30  # Wait 30s after deployment
      period_seconds: 15          # Check every 15s
      timeout_seconds: 5          # Timeout after 5s
      success_threshold: 1        # 1 success = healthy
      failure_threshold: 3        # 3 failures = unhealthy (triggers restart)

# Frontend static site (React/Vite SPA)
static_sites:
  - name: frontend
    
    # Source configuration
    github:
      repo: Bensela/table-talk  # UPDATE THIS to your fork
      branch: main
      deploy_on_push: true
    
    source_dir: frontend
    
    # Build configuration
    build_command: npm install && npm run build
    output_dir: dist
    
    # Environment variables (injected at build time)
    envs:
      - key: VITE_API_URL
        value: /api  # Relative path (same domain as backend)
        scope: BUILD_TIME
    
    # SPA routing support
    catchall_document: index.html

# Database (PostgreSQL)
# OPTION 1: Dev Database (Free/Low-cost, good for MVP)
databases:
  - engine: PG
    name: db  # Referenced as ${db.DATABASE_URL}
    version: "16"
    production: false  # Set to true for managed database features
    cluster_name: table-talk-db  # Optional: custom cluster name

# OPTION 2: Managed Database (Production-ready, high availability)
# Comment out the databases section above and create a managed database separately,
# then attach it via UI or CLI. Managed databases provide:
# - Automated backups
# - High availability with standby nodes
# - Point-in-time recovery
# - Better performance and scalability
#
# To attach an existing managed database:
# 1. Create database: doctl databases create table-talk-pg --engine pg --version 16 --region nyc1
# 2. Attach to app: Go to App Platform UI > Add Database > Select existing managed database
# 3. Add app as trusted source in database settings

# PRE_DEPLOY Job (Optional: Automated migrations)
# Uncomment to run migrations automatically before each deployment
# jobs:
#   - name: db-migrate
#     kind: PRE_DEPLOY
#     github:
#       repo: Bensela/table-talk  # UPDATE THIS to your fork
#       branch: main
#       deploy_on_push: true
#     source_dir: backend
#     run_command: node scripts/migrate.js
#     envs:
#       - key: DATABASE_URL
#         value: ${db.DATABASE_URL}
#         scope: RUN_TIME
#         type: SECRET

# Custom domains (Optional)
# Uncomment and update with your domain after initial deployment
# domains:
#   - domain: tabletalk.app
#     type: PRIMARY
#     zone: tabletalk.app
#   - domain: www.tabletalk.app
#     type: ALIAS
#     zone: tabletalk.app

# Notes:
# - Update the GitHub repo reference (Bensela/table-talk) to your fork
# - Default configuration uses dev database (free tier)
# - For production, consider upgrading to managed database
# - Instance size can be scaled up/down based on traffic
# - Add custom domains after verifying the deployment works
# - Enable PRE_DEPLOY job for automated migrations (optional)
